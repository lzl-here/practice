# 数据预热

## 业务背景
直播时一些KA（key account 关键客户）需要访问店铺数据和店铺底下大量的用户，一开播时会频繁访问这些数据，需要做缓存预热来降低db压力，对于小店铺不做预热操作

需要预热的数据有：
- 店铺数据
- 员工数据
- 用户数据
- 店铺商品数据
- 营销数据
- ....


## 方案
1. 开播前一般都有直播预约，上游直播侧根据这个预约时间，注册一个延迟任务，提前10分钟执行，然后调用各大系统的预热接口进行预热，但我们这是用户系统，只负责店铺数据、员工数据、店铺用户数据
2. 上游传递需要预热的店铺id，先查看redis中是否有预热 **成功** / **进行中**标志，如果有说明出现了某种并发问题，直接返回并且告警，没有则执行预热逻辑
3. 加载店铺数据、加载员工数据，这个数据量不大一次写入
4. 分批次、批量地加载店铺用户数据，一次500条，防止db和redis压力过大
5. 由于某种原因，可能出现写入缓存失败，进行退避重试，超出次数就报警，如果是店铺和员工直接返回，如果是用户就记录下写入的用户id，再次执行时就从这个id开始预热
6. 出现异常后进行人工介入，手动调用预热接口执行重试
7. 执行成功后写入redis成功标志



## 进阶方案

1. 店铺侧通过定时任务拉取预热的店铺
2. 发送MQ到任务调度层，任务调度层将任务进行分片，再下发到worker节点（k8s扩容冷节点，和线上节点分开防止影响线上业务）执行缓存预热

- 任务分片怎么做？
单纯按照店铺id分片，可能出现大店铺集中在某几个任务下，造成数据倾斜问题，所以应该按照用户量分片，查询要预热的店铺时，还能获得店铺下单用户数量，根据用户量分片，每多少个用户一个任务


## Q&A

- **没有预约的直播怎么办呢？**

1. 我们的产品主要面向的知识付费的私域领域，KA都是一些企业，或者机构，或者大v，他们开播都是有计划的，会和他们的用户和我们这提前规划好时间，不预约的概率很小
2. 而不预热的后果也就是开播时访问数据会有些压力，等热点数据加载到缓存后也效果也和预热的差不多了，大部分的KA通过预热已经能拦截掉db承载的大部分流量，漏出这一部分也不多，完全可以接受


- **预热过程中失败了怎么办？**

1. 报警，通知人工介入
2. 对于用户数据记录下当前预热进度，后续重试从这个用户后面开始继续预热


