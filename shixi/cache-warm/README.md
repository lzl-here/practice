# 数据预热

## 业务背景

直播时一些KA（key account 关键客户）需要访问店铺数据和店铺底下大量的用户，一开播时会频繁访问这些数据，需要做缓存预热来降低db压力，对于小店铺不做预热操作

需要预热的数据有：

- 店铺数据
- 员工数据
- 用户数据
- 店铺商品数据
- 营销数据
- ....

## 方案

1. 开播前一般都有直播预约，上游直播侧根据这个预约时间，提前把数据传递过来，这里他们做了个特判，每天下午四点钟，把晚上高峰期直播的大店铺基本信息和直播信息都传过来
2. 上游传递需要预热的店铺id，先查看redis中是否有预热 **成功** / **进行中**标志，如果有说明出现了重复消费，直接返回并且告警，没有则执行预热逻辑
3. 加载店铺数据、加载员工数据，这个数据量不大一次写入
4. 分批次、批量地加载店铺用户数据，一次500条，防止db和redis压力过大
5. 由于某种原因，可能出现写入缓存失败，每次写入缓存后再写入一张消息表，记录最新的用户id，后续通过重试队列读取消息表进行重试，(写入db好处是提供了接口，给开发人员手动执行)
6. 出现异常后触发监控告警，开发人员手动调用预热接口执行重试
7. 执行成功后写入redis成功标志，时间一直到直播结束左右




## Q&A

- 假如将来业务量增长，开播的大店铺很多，或者做什么活动一堆大店铺开播，对db的压力很大，该怎么办？

那为什么不同mq的方案呢？
想要提供可以方便地手动调用的接口，用来方便地排查问题和手动执行预热，可能将来上游那边出了问题，我们这里就调个HTTP请求就能预热


- **没有预约的直播怎么办呢？**

1. 我们的产品主要面向的知识付费的私域领域，KA都是一些企业，或者机构，或者大v，他们开播都是有计划的，会和他们的用户和我们这提前规划好时间，不预约的概率很小
2. 而不预热的后果也就是开播时访问数据会有些压力，等热点数据加载到缓存后也效果也和预热的差不多了，大部分的KA通过预热已经能拦截掉db承载的大部分流量，漏出这一部分也不多，完全可以接受

- **预热过程中失败了怎么办？**

1. 报警，通知人工介入
2. 对于用户数据记录下当前预热进度，后续重试从这个用户后面开始继续预热

- **一次500条这个数据是怎么得到的？ 单协程还是多协程消费？**

1. 一步步测试，监控db的cpu压力、连接数、sql执行时间，在不影响线上业务的情况下，找到一个合适的值保证预热的速度不会太慢

- **为什么用消息表+定时任务？也没有其他方案？**

1. 消息表本身可以做到定时执行，可以起到退避重试的效果，缺点就是延迟问题，但这个场景因为是提前执行预热，只要在开播前把数据预热好就行，所以延迟问题不大
2. 我们公司还有另一种选择，有一个共公的组件：延迟任务中心，可以在那注册一个延迟任务，然后回调我们这边，优点是延迟更小，但我们这个场景不需要这么高的精度

- **数据缓存时间怎么设置？**
  因为上游带上了直播时间，那么根据设置到直播结束后半小时，加上随机10分钟ttl防止雪崩
- **redis锁时间怎么设置的？**
  状态标志，延续到直播结束，期间要是发生错误会删除，等待消息表调度(为什么不等下次mq消费呢？退避重试)
- **怎么部署的？**
  独立消费者进程，部署两个pod，服务器配置？
- **可以优化的点**

1. **进行中的时候宕机了怎么办？**
   分布式锁过期问题
   预热的时候宕机了，这时候还显示进行中怎么办？
   过期时间5分钟，每次写入redis都延期5分钟，保证宕机后能让这个标志过期，然后执行

预热任务和进度问题
但是宕机后，预热进度还能保存吗？
当前的做法是保存不了的，只在异常的时候保存了，其实现在的做法也可以进行人工兜底，让上游再手动调用一次，或者让他们把数据给我们，我们手动调用一次，就是预热进度没有保存，需要重新开始
要做的话，就需要改进一下消息表，加个状态字段，每次来了个任务都去写表，每次预热一批数据就去更新进度，然后定时任务只捞取状态为异常退出的任务进行重试
为了在宕机重启后继续执行旧任务，在程序启动时再开个协程将进行中的任务捞取出来执行

2. **动态调整消费速率**

假如未来业务增长量很大，或者做什么活动，某天晚上要预热的店铺非常多，按照当前的速率，4-7点三个小时也预热不完，要怎么提高消费速率？
1. 扩容pod(但是不划算，因为单个pod的服务器因为限制了消费速率，负载很低)
2. 想要充分利用服务器资源，还得动态调整消费速率
3. 预热前大改预估下数据量大，可以大改推算出一个执行时间，然后根据时间来计算出这3个小时要执行完需要多少协程


- **为什么不用mq？**
希望提供一个接口给开发人员进行手动调用
消息表是拿来即用的，用来做退避重试很简单



- **当前数据量多少？怎么部署的？**
单独的一个pod