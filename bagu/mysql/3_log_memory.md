# 日志

## redolog

记录了数据页的修改情况
InnoDB维护的引擎层的日志，其他引擎没有，用于数据的**持久化**和**容灾恢复**



### redolog写入流程
当向mysql写入数据时，数据并不会立马写入磁盘，而是先写入内存中的buffer pool，里面记录了数据页的修改情况
即使是事务提交也不一定把数据写入磁盘，而是把redolog写入磁盘，这就算是数据的持久化完成，即使这时候发生宕机，此时数据没有落库，我们也可以通过redolog将数据恢复
为什么不直接将数据写入磁盘而要写redolog，后续再把数据写入磁盘？
因为redolog是追加写入的，是顺序io，而数据页在磁盘上的位置是随机的，要写入的位置是随机的，是随机io，磁针会频繁地发生寻道，而顺序io写完一点数据磁针移动一点就行
所以写入redolog而不是数据页是为了性能考虑
ps： 数据页的修改一般是后台定时落库的

### 刷盘机制
类似数据页的刷盘，为了性能，redolog也不是每次执行sql都写入磁盘，而是先写入内存中，等待刷盘时机到来时再写入磁盘

1. 每秒写入
2. 每次事务提交写入(默认，最安全)
3. 不主动刷盘，写入os缓冲区，由os自动刷盘

### checkpoint

redolog的文件是一个环状结构，有两个指针记录写入位置：
- 快指针指向redolog的写入位置
- 慢指针指向数据页的刷盘进度

当快指针碰到慢指针的时候，说明此时数据页的刷盘进度远远落后于redolog的写入，此时强制进行数据页的刷盘
ps: 文件默认4G

为什么redolog支持容灾备份而binlog不支持？
因为redolog记录了当前页的刷盘进度，知道redolog中需要从哪开始恢复
binlog没有进度，比如binlog中有一个a = a + 1, 我们不知道这个操作也没有写入磁盘，也就不知道要不要恢复这个操作


## undolog

InnoDB维护的引擎层的日志，其他引擎没有，用于数据的**原子性**
两个场景：事务回滚和mvcc


## binlog

服务层日志，每个引擎都有，用于数据归档和主从复制

1. 主从复制（Replication）
2. 数据备份（
3. 数据订阅与异构系统同步
4. 审计与变更追踪


### 刷盘策略
1. 写入os缓冲区，由os自动刷盘(默认)
2. 每次事务提交写入


## 二阶段提交
TODO
